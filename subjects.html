<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Qu·∫£n tr·ªã h·ªá th·ªëng</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="data:,">
  <style>
    body { padding-top: 70px; background: #fff }
    .top-btn-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 16px }
    .top-btn-bar .btn { margin-bottom: 0!important }
    .top-btn-bar .ms-auto { margin-left: auto!important }
    .mode-section { display: none }
    #logoutBtn { margin: 1rem 0 }
    .subject-scroll-select { max-height: 240px!important; overflow-y: auto!important }
    .fw-medium { font-weight: 500 }
    .bg-light-section { background: #f8f9fa; border-radius: 8px; margin-bottom: 24px; }
    .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 12px }

    #subjectList, .syllabus-list-scroll { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px 5px; background: #fafbfc }
    .syllabus-list-item, .subject-list-item { border-bottom: 1px solid #e0e0e0; padding: 16px 0 }
    .syllabus-list-item:last-child, .subject-list-item:last-child { border-bottom: none }

    .question-list-section { display: none; margin-top: 24px }
    .question-list-scroll { max-height: 430px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 5px; padding: 10px }
    .question-list-item { border-bottom: 1px solid #e0e0e0; padding: 16px 0 }
    .question-list-item:last-child { border-bottom: none }
    .question-list-answers { margin-left: 1.5em; margin-top: 8px }
    .question-list-answers .correct { color: #198754; font-weight: 700 }
    .question-list-answers .answer-item { margin-bottom: 2px }

    .img-preview, .img-preview-ans { max-width: 120px; max-height: 70px; display: inline-block; margin-top: 6px; vertical-align: middle }
    .img-preview-ans { max-width: 70px; max-height: 40px }
    .img-upload-btn { margin-top: 3px }
    .remove-img-btn { margin-left: 6px; color: red; border: none; background: none }

    .search-bar { margin-bottom: 16px }
    .filter-bar { margin-bottom: 16px; max-width: 350px }
    .edit-form { background: #f4f7fa; padding: 16px; border-radius: 8px; margin-bottom: 24px }
    .edit-form .form-control { margin-bottom: 8px }
    .mathjax-content { font-size: 1.05em }

    #editQuestionModal .edit-form { max-height: 430px; overflow-y: auto; }
    #editQuestionModal .form-scroll { max-height: 430px; overflow-y: auto; }

    #importHtmlResultContainer { max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 5px; padding: 12px }
    #importHtmlStats { font-size: 1em; margin-bottom: 16px; }
    #importHtmlStats.bg-light { background: #f8f9fa!important }
    #importHtmlResult .import-question { margin-bottom: 1.5em }
    #importHtmlResult .import-answer { margin-left: 2em }
    #importHtmlResult .import-answer-correct { color: #198754; font-weight: 700 }
    #importHtmlResult .import-duplicate { color: #c00 }
    #importHtmlResult { font-size: 1.05em }

    .hint-box { font-size: 0.9rem; color: #6c757d; }
    .code-ok { color: #198754; font-weight: 600; }
    .code-bad { color: #dc3545; font-weight: 600; }

    /* Modal image size editor */
    #imageSizeModal { display:none; position:fixed; z-index:3000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,.35); align-items:center; justify-content:center }
    #imageSizeModal .inner { background:#fff; max-width:720px; width:96%; max-height:80vh; overflow:auto; padding:16px; border-radius:8px; box-shadow:0 6px 30px rgba(0,0,0,.25) }
    .img-size-row { display:flex; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid #eee }
    .img-size-row img { max-width:140px; max-height:90px; object-fit:contain; border:1px solid #ddd; padding:4px; background:#fff }
    .img-size-controls { flex:1; display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .img-size-controls input { max-width:130px }
    .img-size-note { font-size:0.9rem; color:#666 }

    @media (max-width:600px) {
      .question-list-scroll { max-height: 320px }
      #importHtmlResultContainer { max-height: 210px }
      .syllabus-list-scroll { max-height: 210px }
      .img-size-row { flex-direction:column; align-items:flex-start }
      .img-size-controls input { max-width:100% }
    }

    /* Custom dropdown list style (like upload.html v5) */
    .subject-list-dropdown { max-height: 260px; overflow-y: auto; min-width: 100%; padding: 0.25rem; }
    .subject-list-dropdown .dropdown-item { white-space: normal; border-bottom: 1px solid #f0f0f0; cursor: pointer; padding: .375rem .75rem; }
    .subject-list-dropdown .dropdown-item:hover { background-color: #f8f9fa; }
    .dropdown .sticky-top { z-index:1055; } /* keep search on top */
  </style>

  <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body class="bg-light">
<header id="navbar-placeholder"></header>

<div class="container py-4">
  <div class="top-btn-bar">
    <button class="btn btn-secondary d-none" id="backToChoice1">‚Üê Quay l·∫°i</button>
    <button class="btn btn-secondary d-none" id="backToChoice2">‚Üê Quay l·∫°i</button>
    <button class="btn btn-secondary d-none" id="backToChoice3">‚Üê Quay l·∫°i</button>
    <button class="btn btn-sm btn-danger ms-auto" id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</button>
  </div>

  <h4 class="mb-4">Ch·ªçn lo·∫°i upload:</h4>
  <select class="form-select mb-3" style="max-width:320px" id="modeSelect">
    <option value="subject">Qu·∫£n tr·ªã M√¥n h·ªçc</option>
    <option value="syllabus">Qu·∫£n tr·ªã ƒê·ªÅ c∆∞∆°ng</option>
    <option value="question">Qu·∫£n tr·ªã C√¢u h·ªèi</option>
  </select>

  <!-- Qu·∫£n tr·ªã M√¥n h·ªçc -->
  <div class="mode-section" id="subjectSection">
    <div class="bg-light-section p-3 mb-4">
      <div class="section-title">‚ûï Th√™m m√¥n h·ªçc</div>
      <form class="mb-3" id="subjectForm">
        <input class="form-control mb-2" id="subjectName" placeholder="T√™n m√¥n h·ªçc" required>
        <button class="btn btn-success">Th√™m</button>
      </form>
      <div id="subjectList"></div>
    </div>
  </div>

  <!-- Qu·∫£n tr·ªã ƒê·ªÅ c∆∞∆°ng -->
  <div class="mode-section syllabus-list-section" id="syllabusSection">
    <div class="bg-light-section p-3 mb-4">
      <div class="section-title mb-2">Danh s√°ch ƒë·ªÅ c∆∞∆°ng</div>
      <div class="mb-3 row">
        <div class="col-md-6">
          <!-- replaced select with searchable dropdown (upload.html v5 style) -->
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" id="btnSyllabusFilter" data-bs-toggle="dropdown" aria-expanded="false">T·∫•t c·∫£ m√¥n h·ªçc</button>
            <ul class="dropdown-menu p-2 subject-list-dropdown" id="listSyllabusFilter" aria-labelledby="btnSyllabusFilter"></ul>
          </div>
          <input type="hidden" id="valSyllabusFilter" value="">
        </div>
        <div class="col-md-6">
          <input id="syllabusSearchInput" class="form-control mb-2" placeholder="T√¨m ki·∫øm t√™n file ho·∫∑c ch·ªß s·ªü h·ªØu...">
        </div>
      </div>
      <div class="syllabus-list-scroll">
        <div id="syllabusListView"></div>
      </div>
    </div>

    <div id="editSyllabusModal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,.2);align-items:center;justify-content:center">
      <div style="background:#fff;max-width:480px;width:96%;margin:auto;box-shadow:0 4px 32px #0002;padding:20px;position:relative">
        <button id="closeEditSyllabusModal" style="position:absolute;top:6px;right:12px;border:none;background:0 0;font-size:22px">√ó</button>
        <h5>S·ª≠a ƒë·ªÅ c∆∞∆°ng</h5>
        <form id="editSyllabusForm" class="edit-form">
          <!-- replaced select with searchable dropdown -->
          <div class="dropdown mb-2">
            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" id="btnEditSyllabusSubject" data-bs-toggle="dropdown" aria-expanded="false">Ch·ªçn m√¥n h·ªçc</button>
            <ul class="dropdown-menu p-2 subject-list-dropdown" id="listEditSyllabusSubject" aria-labelledby="btnEditSyllabusSubject"></ul>
          </div>
          <input type="hidden" id="valEditSyllabusSubject" value="">
          <input class="form-control" id="editSyllabusOwner" placeholder="T√†i li·ªáu n√†y c·ªßa ai? (Kh√¥ng b·∫Øt bu·ªôc)">
          <input class="form-control mb-2" id="editSyllabusFileLink" placeholder="ƒê∆∞·ªùng link file (Google Drive...)">
          <div id="currentFileName" class="mb-2"></div>
          <button type="submit" class="btn btn-success mt-2">L∆∞u thay ƒë·ªïi</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Qu·∫£n tr·ªã C√¢u h·ªèi -->
  <div class="mode-section" id="questionSection">
    <div class="mb-3" id="questionModeChoice">
      <button class="btn btn-primary me-2" id="importHtmlBtn">Nh·∫≠p t·ª´ file HTML</button>
      <button class="btn btn-success me-2" id="manualBtn">Th√™m th·ªß c√¥ng</button>
      <button class="btn btn-outline-secondary" id="viewQuestionListBtn">Xem danh s√°ch c√¢u h·ªèi</button>
    </div>

    <!-- Import t·ª´ file HTML Moodle -->
    <div id="importHtmlSection" style="display:none">
      <h5 class="mb-3">Nh·∫≠p c√¢u h·ªèi t·ª´ file HTML Moodle</h5>

      <!-- replaced select with searchable dropdown -->
      <div class="dropdown mb-2" style="max-width:350px">
        <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" id="btnImportSubject" data-bs-toggle="dropdown" aria-expanded="false">-- Ch·ªçn m√¥n h·ªçc ƒë·ªÉ l∆∞u --</button>
        <ul class="dropdown-menu p-2 subject-list-dropdown" id="listImportSubject" aria-labelledby="btnImportSubject"></ul>
      </div>
      <input type="hidden" id="valImportSubject" value="">
      <input type="file" id="importHtmlInput" accept=".html,.htm" class="form-control mb-2" style="max-width:350px;" disabled>

      <div class="mt-2" style="max-width:350px">
        <label class="form-label">Security code</label>
        <input id="questionSecurityCodeImport" type="password" class="form-control" placeholder="Nh·∫≠p security code">
        <small id="questionSecurityStatusImport" class="text-muted"></small>
      </div>

      <div class="hint-box mt-2">
        ‚Ä¢ Ch·ªâ khi <b>code ƒë√∫ng</b> th√¨ n√∫t l∆∞u m·ªõi ho·∫°t ƒë·ªông.
      </div>

      <div id="importHtmlStats" class="bg-light border rounded mb-3 px-3 py-2 mt-2" style="display:none"></div>

      <div id="importHtmlResultContainer">
        <div id="importHtmlResult" class="mt-3"></div>
      </div>

      <button class="btn btn-success mt-2" id="saveImportBtn" style="display:none" disabled>üíæ L∆∞u v√†o CSDL</button>
    </div>

    <!-- Th√™m th·ªß c√¥ng -->
    <div id="manualSection" style="display:none">
      <h5>Th√™m c√¢u h·ªèi th·ªß c√¥ng</h5>

      <form id="questionForm" autocomplete="off">
        <!-- replaced select with searchable dropdown -->
        <div class="dropdown mb-2" style="max-width:350px">
          <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" id="btnManualSubject" data-bs-toggle="dropdown" aria-expanded="false">Ch·ªçn m√¥n h·ªçc</button>
          <ul class="dropdown-menu p-2 subject-list-dropdown" id="listManualSubject" aria-labelledby="btnManualSubject"></ul>
        </div>
        <input type="hidden" id="valManualSubject" value="">

        <div class="d-flex gap-2 align-items-start mb-2">
          <textarea class="form-control" id="questionText" placeholder="N·ªôi dung c√¢u h·ªèi (h·ªó tr·ª£ MathJax / c√≥ th·ªÉ ch·ª©a <img ...>)" required rows="3" style="flex:1"></textarea>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnEditImgSizeManual">Ch·ªânh k√≠ch th∆∞·ªõc ·∫£nh</button>
          </div>
        </div>

        <div class="answer-input-group mb-2 d-flex gap-2">
          <div style="flex:1">
            <label for="answerA" class="form-label mb-1">ƒê√°p √°n a</label>
            <input class="form-control" id="answerA" placeholder="ƒê√°p √°n a (c√≥ th·ªÉ ch·ª©a <img ...>)" required>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <label class="form-label mb-1 invisible">btn</label>
            <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-img-size" data-target="answerA">Ch·ªânh k√≠ch th∆∞·ªõc ·∫£nh</button>
          </div>
        </div>

        <div class="answer-input-group mb-2 d-flex gap-2">
          <div style="flex:1">
            <label for="answerB" class="form-label mb-1">ƒê√°p √°n b</label>
            <input class="form-control" id="answerB" placeholder="ƒê√°p √°n b (c√≥ th·ªÉ ch·ª©a <img ...>)" required>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <label class="form-label mb-1 invisible">btn</label>
            <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-img-size" data-target="answerB">Ch·ªânh k√≠ch th∆∞·ªõc ·∫£nh</button>
          </div>
        </div>

        <div class="answer-input-group mb-2 d-flex gap-2">
          <div style="flex:1">
            <label for="answerC" class="form-label mb-1">ƒê√°p √°n c</label>
            <input class="form-control" id="answerC" placeholder="ƒê√°p √°n c (c√≥ th·ªÉ ch·ª©a <img ...>)" required>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <label class="form-label mb-1 invisible">btn</label>
            <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-img-size" data-target="answerC">Ch·ªânh k√≠ch th∆∞·ªõc ·∫£nh</button>
          </div>
        </div>

        <div class="answer-input-group mb-2 d-flex gap-2">
          <div style="flex:1">
            <label for="answerD" class="form-label mb-1">ƒê√°p √°n d</label>
            <input class="form-control" id="answerD" placeholder="ƒê√°p √°n d (c√≥ th·ªÉ ch·ª©a <img ...>)" required>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <label class="form-label mb-1 invisible">btn</label>
            <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-img-size" data-target="answerD">Ch·ªânh k√≠ch th∆∞·ªõc ·∫£nh</button>
          </div>
        </div>

        <select class="form-select mb-2" id="correctAnswerDropdown" required>
          <option value="">Ch·ªçn ƒë√°p √°n ƒë√∫ng</option>
          <option value="a">a</option>
          <option value="b">b</option>
          <option value="c">c</option>
          <option value="d">d</option>
        </select>

        <div class="mt-2" style="max-width:350px">
          <label class="form-label">Security code</label>
          <input id="questionSecurityCodeManual" type="password" class="form-control" placeholder="Nh·∫≠p security code">
          <small id="questionSecurityStatusManual" class="text-muted"></small>
        </div>

        <button type="submit" class="btn btn-success mt-2" id="submitQuestionBtn">Th√™m c√¢u h·ªèi</button>
      </form>
    </div>

    <!-- Danh s√°ch c√¢u h·ªèi -->
    <div class="question-list-section" id="questionListSection">
      <div class="row">
        <div class="col-md-6 search-bar">
          <input id="questionSearchInput" class="form-control" placeholder="T√¨m ki·∫øm n·ªôi dung c√¢u h·ªèi...">
        </div>
        <div class="col-md-6 filter-bar">
          <!-- replaced select with searchable dropdown -->
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" id="btnQuestionFilter" data-bs-toggle="dropdown" aria-expanded="false">T·∫•t c·∫£ m√¥n h·ªçc</button>
            <ul class="dropdown-menu p-2 subject-list-dropdown" id="listQuestionFilter" aria-labelledby="btnQuestionFilter"></ul>
          </div>
          <input type="hidden" id="valQuestionFilter" value="">
        </div>
      </div>

      <div id="bulk-action-bar" class="d-flex align-items-center mb-2" style="display: none !important;">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
          <label class="form-check-label" for="selectAllCheckbox">Ch·ªçn t·∫•t c·∫£</label>
        </div>
        <button class="btn btn-sm btn-danger ms-3" id="deleteSelectedBtn" style="display: none;">
          üóëÔ∏è X√≥a c√°c m·ª•c ƒë√£ ch·ªçn
        </button>
      </div>

      <div class="question-list-scroll">
        <div id="questionListView"></div>
      </div>
    </div>

    <!-- Modal s·ª≠a c√¢u h·ªèi -->
    <div id="editQuestionModal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,.2);align-items:center;justify-content:center">
      <div style="background:#fff;max-width:620px;width:96%;margin:auto;box-shadow:0 4px 32px #0002;padding:20px;position:relative">
        <button id="closeEditModal" style="position:absolute;top:6px;right:12px;border:none;background:0 0;font-size:22px">√ó</button>
        <h5>S·ª≠a c√¢u h·ªèi</h5>

        <div class="hint-box mb-2">
          ‚úÖ B·∫°n c√≥ th·ªÉ <b>Ctrl+V</b> ƒë·ªÉ d√°n ·∫£nh tr·ª±c ti·∫øp v√†o √¥ n·ªôi dung/ƒë√°p √°n. ·∫¢nh s·∫Ω ƒë∆∞·ª£c ch√®n d·∫°ng:
          <code>&lt;img src="data:image/png;base64,..."&gt;</code>
        </div>

        <div class="form-scroll">
          <form id="editForm" class="edit-form">

            <!-- replaced select with searchable dropdown -->
            <div class="dropdown mb-2">
              <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" id="btnEditSubject" data-bs-toggle="dropdown" aria-expanded="false">Ch·ªçn m√¥n h·ªçc</button>
              <ul class="dropdown-menu p-2 subject-list-dropdown" id="listEditSubject" aria-labelledby="btnEditSubject"></ul>
            </div>
            <input type="hidden" id="valEditSubject" value="">

            <label class="form-label mb-1">N·ªôi dung c√¢u h·ªèi</label>
            <div class="d-flex gap-2 align-items-start mb-2">
              <textarea class="form-control" id="editQuestionText" required rows="4"
                placeholder="B·∫°n c√≥ th·ªÉ Ctrl+V ·∫£nh v√†o ƒë√¢y..."></textarea>
              <div style="display:flex;flex-direction:column;gap:6px">
                <input type="file" accept="image/*" id="editPasteImageFile" class="form-control form-control-sm" style="max-width:220px">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btnInsertImageToQuestion">Ch√®n ·∫£nh v√†o c√¢u h·ªèi</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnEditImgSizeQuestion">Ch·ªânh k√≠ch th∆∞·ªõc ·∫£nh</button>
              </div>
            </div>

            <hr>

            <div class="mb-2 mt-2">
              <label class="form-label mb-1">ƒê√°p √°n a</label>
              <div class="d-flex gap-2">
                <textarea class="form-control" id="editAnswerA" required rows="2" placeholder="Ctrl+V ·∫£nh ƒë∆∞·ª£c..."></textarea>
                <div style="display:flex;flex-direction:column;gap:6px">
                  <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-img-size-single" data-target="editAnswerA">Ch·ªânh k√≠ch th∆∞·ªõc</button>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label mb-1">ƒê√°p √°n b</label>
              <div class="d-flex gap-2">
                <textarea class="form-control" id="editAnswerB" required rows="2" placeholder="Ctrl+V ·∫£nh ƒë∆∞·ª£c..."></textarea>
                <div style="display:flex;flex-direction:column;gap:6px">
                  <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-img-size-single" data-target="editAnswerB">Ch·ªânh k√≠ch th∆∞·ªõc</button>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label mb-1">ƒê√°p √°n c</label>
              <div class="d-flex gap-2">
                <textarea class="form-control" id="editAnswerC" required rows="2" placeholder="Ctrl+V ·∫£nh ƒë∆∞·ª£c..."></textarea>
                <div style="display:flex;flex-direction:column;gap:6px">
                  <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-img-size-single" data-target="editAnswerC">Ch·ªânh k√≠ch th∆∞·ªõc</button>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label mb-1">ƒê√°p √°n d</label>
              <div class="d-flex gap-2">
                <textarea class="form-control" id="editAnswerD" required rows="2" placeholder="Ctrl+V ·∫£nh ƒë∆∞·ª£c..."></textarea>
                <div style="display:flex;flex-direction:column;gap:6px">
                  <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-img-size-single" data-target="editAnswerD">Ch·ªânh k√≠ch th∆∞·ªõc</button>
                </div>
              </div>
            </div>

            <select class="form-select" id="editCorrectAnswerDropdown" required>
              <option value="">Ch·ªçn ƒë√°p √°n ƒë√∫ng</option>
              <option value="a">a</option>
              <option value="b">b</option>
              <option value="c">c</option>
              <option value="d">d</option>
            </select>

            <div class="mt-2" style="max-width:350px">
              <label class="form-label">Security code</label>
              <input id="questionSecurityCodeEdit" type="password" class="form-control" placeholder="Nh·∫≠p security code ƒë·ªÉ s·ª≠a">
              <small id="questionSecurityStatusEdit" class="text-muted"></small>
            </div>

            <button type="submit" class="btn btn-success mt-2">L∆∞u thay ƒë·ªïi</button>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Image Size Editor Modal -->
<div id="imageSizeModal">
  <div class="inner">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Ch·ªânh k√≠ch th∆∞·ªõc ·∫£nh</h5>
      <div>
        <button id="imageSizeApplyBtn" class="btn btn-sm btn-success">√Åp d·ª•ng</button>
        <button id="imageSizeCloseBtn" class="btn btn-sm btn-secondary">ƒê√≥ng</button>
      </div>
    </div>
    <div id="imageSizeList"></div>
    <div class="mt-2 img-size-note">Ghi ch√∫: Nh·∫≠p gi√° tr·ªã k√®m ƒë∆°n v·ªã (px ho·∫∑c %). B·ªè tr·ªëng ƒë·ªÉ x√≥a thu·ªôc t√≠nh k√≠ch th∆∞·ªõc.</div>
  </div>
</div>

<script type="module">
  // Firebase & Auth
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDoc, getDocs, updateDoc, deleteDoc, doc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  // -- FIREBASE CONFIG --
  const firebaseConfig = {
    apiKey: "AIzaSyBMZok_E4NkCzUMrFhlWCeL7Qr0nXIBIrE",
    authDomain: "webtracuu-ce364.firebaseapp.com",
    projectId: "webtracuu-ce364",
    storageBucket: "webtracuu-ce364.firebasestorage.app",
    messagingSenderId: "180686806388",
    appId: "1:180686806388:web:a6f2939cf93f47c7286021",
    measurementId: "G-84M470HXNH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ===== AUTH GUARD =====
  onAuthStateChanged(auth, (user) => {
    if (!user) location.href = "ad.login";
  });
  document.getElementById("logoutBtn").addEventListener("click", () => {
    signOut(auth).then(() => location.href = "ad.login");
  });

  // ========= SECURITY CODE HELPERS =========
  async function verifySecurityCode(code) {
    const val = (code || "").trim();
    if (!val) return false;
    const snap = await getDoc(doc(db, "config", "security_code"));
    return snap.exists() && snap.data().code === val;
  }

  function setCodeStatus(el, ok, msgOk="‚úÖ Security code ƒë√∫ng", msgBad="‚ùå Security code sai") {
    if (!el) return;
    el.textContent = ok ? msgOk : msgBad;
    el.className = ok ? "code-ok" : "code-bad";
  }

  // Import code state
  let questionSecOKImport = false;
  const secImportEl = document.getElementById("questionSecurityCodeImport");
  const secImportStatus = document.getElementById("questionSecurityStatusImport");

  // Manual code state
  let questionSecOKManual = false;
  const secManualEl = document.getElementById("questionSecurityCodeManual");
  const secManualStatus = document.getElementById("questionSecurityStatusManual");

  // Edit code state
  let questionSecOKEdit = false;
  const secEditEl = document.getElementById("questionSecurityCodeEdit");
  const secEditStatus = document.getElementById("questionSecurityStatusEdit");

  // ===== Clipboard image -> base64 -> insert <img> =====
  function insertAtCursor(textarea, insertText) {
    const start = textarea.selectionStart ?? textarea.value.length;
    const end = textarea.selectionEnd ?? textarea.value.length;
    const before = textarea.value.slice(0, start);
    const after = textarea.value.slice(end);
    textarea.value = before + insertText + after;
    const newPos = start + insertText.length;
    textarea.focus();
    textarea.setSelectionRange(newPos, newPos);
  }

  function approxBytesFromDataUrl(dataUrl) {
    const base64 = dataUrl.split(",")[1] || "";
    return Math.floor(base64.length * 0.75);
  }

  async function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function bindPasteImageToTextarea(textarea) {
    if (!textarea) return;

    textarea.addEventListener("paste", async (e) => {
      try {
        const items = e.clipboardData?.items;
        if (!items) return;

        let imageFile = null;
        for (const it of items) {
          if (it.type && it.type.startsWith("image/")) {
            imageFile = it.getAsFile();
            break;
          }
        }
        if (!imageFile) return;

        e.preventDefault(); // ngƒÉn d√°n text r√°c
        const dataUrl = await fileToDataUrl(imageFile);

        const bytes = approxBytesFromDataUrl(dataUrl);
        if (bytes > 350 * 1024) {
          if (!confirm(`·∫¢nh b·∫°n d√°n ~${Math.round(bytes/1024)}KB. D·ªØ li·ªáu Firestore c√≥ th·ªÉ l·ªõn. V·∫´n ch√®n?`)) return;
        }

        const tag = `\n<img src="${dataUrl}">\n`;
        insertAtCursor(textarea, tag);
      } catch (err) {
        console.error("Paste image error:", err);
        alert("Kh√¥ng th·ªÉ d√°n ·∫£nh. Xem Console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.");
      }
    });
  }

  // ========= DOM refs =========
  const modeSelect = document.getElementById("modeSelect");
  const subjectSection = document.getElementById("subjectSection");
  const syllabusSection = document.getElementById("syllabusSection");
  const questionSection = document.getElementById("questionSection");

  const backToChoice1 = document.getElementById("backToChoice1");
  const backToChoice2 = document.getElementById("backToChoice2");
  const backToChoice3 = document.getElementById("backToChoice3");

  // Subject CRUD
  const subjectForm = document.getElementById("subjectForm");
  const subjectName = document.getElementById("subjectName");
  const subjectList = document.getElementById("subjectList");
  // dropdown elements (custom)
  const btnSyllabusFilter = document.getElementById("btnSyllabusFilter");
  const listSyllabusFilter = document.getElementById("listSyllabusFilter");
  const valSyllabusFilter = document.getElementById("valSyllabusFilter");

  const btnEditSyllabusSubject = document.getElementById("btnEditSyllabusSubject");
  const listEditSyllabusSubject = document.getElementById("listEditSyllabusSubject");
  const valEditSyllabusSubject = document.getElementById("valEditSyllabusSubject");

  // Syllabus CRUD
  const syllabusSearchInput = document.getElementById("syllabusSearchInput");
  const syllabusListView = document.getElementById("syllabusListView");
  const editSyllabusModal = document.getElementById("editSyllabusModal");
  const closeEditSyllabusModal = document.getElementById("closeEditSyllabusModal");
  const editSyllabusForm = document.getElementById("editSyllabusForm");
  const editSyllabusOwner = document.getElementById("editSyllabusOwner");
  const editSyllabusFileLink = document.getElementById("editSyllabusFileLink");
  let allSyllabusRaw = [];
  let currentEditSyllabusId = null;

  // Question mode
  const questionModeChoice = document.getElementById("questionModeChoice");
  const importHtmlBtn = document.getElementById("importHtmlBtn");
  const manualBtn = document.getElementById("manualBtn");
  const viewQuestionListBtn = document.getElementById("viewQuestionListBtn");

  const importHtmlSection = document.getElementById("importHtmlSection");
  const manualSection = document.getElementById("manualSection");
  const questionListSection = document.getElementById("questionListSection");

  // Import UI (custom dropdown)
  const btnImportSubject = document.getElementById("btnImportSubject");
  const listImportSubject = document.getElementById("listImportSubject");
  const valImportSubject = document.getElementById("valImportSubject");
  const importHtmlInput = document.getElementById("importHtmlInput");
  const importHtmlResult = document.getElementById("importHtmlResult");
  const importHtmlStats = document.getElementById("importHtmlStats");
  const saveImportBtn = document.getElementById("saveImportBtn");

  // Manual UI (custom dropdown)
  const btnManualSubject = document.getElementById("btnManualSubject");
  const listManualSubject = document.getElementById("listManualSubject");
  const valManualSubject = document.getElementById("valManualSubject");
  const questionForm = document.getElementById("questionForm");
  const questionText = document.getElementById("questionText");
  const answerA = document.getElementById("answerA");
  const answerB = document.getElementById("answerB");
  const answerC = document.getElementById("answerC");
  const answerD = document.getElementById("answerD");
  const correctAnswerDropdown = document.getElementById("correctAnswerDropdown");
  const btnEditImgSizeManual = document.getElementById("btnEditImgSizeManual");

  // List UI (custom dropdown)
  const questionSearchInput = document.getElementById("questionSearchInput");
  const btnQuestionFilter = document.getElementById("btnQuestionFilter");
  const listQuestionFilter = document.getElementById("listQuestionFilter");
  const valQuestionFilter = document.getElementById("valQuestionFilter");
  const questionListView = document.getElementById("questionListView");
  const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
  const selectAllCheckbox = document.getElementById("selectAllCheckbox");

  // Edit modal UI (custom dropdown)
  const btnEditSubject = document.getElementById("btnEditSubject");
  const listEditSubject = document.getElementById("listEditSubject");
  const valEditSubject = document.getElementById("valEditSubject");
  const editQuestionModal = document.getElementById("editQuestionModal");
  const closeEditModal = document.getElementById("closeEditModal");
  const editForm = document.getElementById("editForm");
  const editQuestionText = document.getElementById("editQuestionText");
  const editAnswerA = document.getElementById("editAnswerA");
  const editAnswerB = document.getElementById("editAnswerB");
  const editAnswerC = document.getElementById("editAnswerC");
  const editAnswerD = document.getElementById("editAnswerD");
  const editCorrectAnswerDropdown = document.getElementById("editCorrectAnswerDropdown");

  const editPasteImageFile = document.getElementById("editPasteImageFile");
  const btnInsertImageToQuestion = document.getElementById("btnInsertImageToQuestion");
  const btnEditImgSizeQuestion = document.getElementById("btnEditImgSizeQuestion");

  // Image size modal refs
  const imageSizeModal = document.getElementById("imageSizeModal");
  const imageSizeList = document.getElementById("imageSizeList");
  const imageSizeApplyBtn = document.getElementById("imageSizeApplyBtn");
  const imageSizeCloseBtn = document.getElementById("imageSizeCloseBtn");

  // Bind Ctrl+V paste image to edit textareas and manual textarea
  bindPasteImageToTextarea(editQuestionText);
  bindPasteImageToTextarea(editAnswerA);
  bindPasteImageToTextarea(editAnswerB);
  bindPasteImageToTextarea(editAnswerC);
  bindPasteImageToTextarea(editAnswerD);
  bindPasteImageToTextarea(questionText);

  // Optional: ch√®n ·∫£nh t·ª´ file v√†o n·ªôi dung c√¢u h·ªèi (edit)
  btnInsertImageToQuestion.addEventListener("click", async () => {
    const f = editPasteImageFile.files?.[0];
    if (!f) return alert("B·∫°n ch∆∞a ch·ªçn file ·∫£nh.");
    try {
      const dataUrl = await fileToDataUrl(f);
      const bytes = approxBytesFromDataUrl(dataUrl);
      if (bytes > 350 * 1024) {
        if (!confirm(`·∫¢nh ~${Math.round(bytes/1024)}KB. V·∫´n ch√®n?`)) return;
      }
      insertAtCursor(editQuestionText, `\n<img src="${dataUrl}">\n`);
      editPasteImageFile.value = "";
    } catch (e) {
      console.error(e);
      alert("Kh√¥ng ch√®n ƒë∆∞·ª£c ·∫£nh. Xem Console (F12).");
    }
  });

  // ===== Image Size Editor Logic =====
  let currentFieldEl = null;
  function openImageSizeEditorForField(fieldEl) {
    if (!fieldEl) return;
    currentFieldEl = fieldEl;
    const tmp = document.createElement('div');
    tmp.innerHTML = fieldEl.value || '';
    const imgs = Array.from(tmp.querySelectorAll('img'));
    imageSizeList.innerHTML = '';

    if (imgs.length === 0) {
      imageSizeList.innerHTML = '<div class="text-muted">Kh√¥ng t√¨m th·∫•y ·∫£nh trong n·ªôi dung n√†y.</div>';
    } else {
      imgs.forEach((img, idx) => {
        const row = document.createElement('div');
        row.className = 'img-size-row';
        const preview = document.createElement('img');
        preview.src = img.src;
        preview.alt = 'img-' + idx;

        const controls = document.createElement('div');
        controls.className = 'img-size-controls';

        const label = document.createElement('div');
        label.innerHTML = `<strong>·∫¢nh ${idx+1}</strong>`;

        const widthInput = document.createElement('input');
        widthInput.type = 'text';
        widthInput.placeholder = 'width (e.g. 200px or 50%)';
        widthInput.className = 'form-control form-control-sm';
        const preWidth = img.getAttribute('width') || (img.style && img.style.width) || '';
        if (preWidth) widthInput.value = preWidth;

        const heightInput = document.createElement('input');
        heightInput.type = 'text';
        heightInput.placeholder = 'height (e.g. 150px or 30%)';
        heightInput.className = 'form-control form-control-sm';
        const preHeight = img.getAttribute('height') || (img.style && img.style.height) || '';
        if (preHeight) heightInput.value = preHeight;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-sm btn-outline-danger';
        removeBtn.textContent = 'X√≥a k√≠ch th∆∞·ªõc';
        removeBtn.addEventListener('click', () => {
          widthInput.value = '';
          heightInput.value = '';
        });

        widthInput.dataset.imgIndex = idx;
        heightInput.dataset.imgIndex = idx;

        controls.appendChild(label);
        controls.appendChild(widthInput);
        controls.appendChild(heightInput);
        controls.appendChild(removeBtn);

        row.appendChild(preview);
        row.appendChild(controls);
        imageSizeList.appendChild(row);
      });
    }

    imageSizeModal.style.display = 'flex';
  }

  imageSizeApplyBtn.addEventListener('click', () => {
    if (!currentFieldEl) return;
    const tmp = document.createElement('div');
    tmp.innerHTML = currentFieldEl.value || '';
    const imgs = Array.from(tmp.querySelectorAll('img'));
    if (imgs.length === 0) {
      imageSizeModal.style.display = 'none';
      return;
    }
    const inputs = imageSizeList.querySelectorAll('input');
    inputs.forEach(inp => {
      const idx = parseInt(inp.dataset.imgIndex, 10);
      const val = (inp.value || '').trim();
      const isWidth = inp.placeholder && inp.placeholder.toLowerCase().includes('width');
      const img = imgs[idx];
      if (!img) return;
      if (isWidth) {
        if (val) { img.style.width = val; img.removeAttribute('width'); } else { img.style.width = ''; img.removeAttribute('width'); }
      } else {
        if (val) { img.style.height = val; img.removeAttribute('height'); } else { img.style.height = ''; img.removeAttribute('height'); }
      }
    });
    imgs.forEach(img => {
      if (img.style && img.style.width === '' && img.style.height === '') {
        img.removeAttribute('style');
      }
    });
    currentFieldEl.value = tmp.innerHTML;
    imageSizeModal.style.display = 'none';
  });

  imageSizeCloseBtn.addEventListener('click', () => {
    imageSizeModal.style.display = 'none';
  });

  function openImageSizeEditorById(id) {
    const el = document.getElementById(id);
    if (!el) return alert('Kh√¥ng t√¨m th·∫•y √¥ n·ªôi dung.');
    openImageSizeEditorForField(el);
  }

  btnEditImgSizeManual && btnEditImgSizeManual.addEventListener('click', () => {
    openImageSizeEditorForField(questionText);
  });

  document.querySelectorAll('.btn-edit-img-size').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      const el = document.getElementById(target);
      if (!el) return alert('Kh√¥ng t√¨m th·∫•y √¥ ƒë√°p √°n.');
      openImageSizeEditorForField(el);
    });
  });

  btnEditImgSizeQuestion && btnEditImgSizeQuestion.addEventListener('click', () => {
    openImageSizeEditorForField(editQuestionText);
  });

  document.querySelectorAll('.btn-edit-img-size-single').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      const el = document.getElementById(target);
      if (!el) return alert('Kh√¥ng t√¨m th·∫•y √¥ ƒë√°p √°n.');
      openImageSizeEditorForField(el);
    });
  });

  // ===== SECURITY CODE INPUT EVENTS =====
  if (secImportEl) {
    secImportEl.addEventListener("input", async () => {
      questionSecOKImport = false;
      saveImportBtn.disabled = true;
      secImportStatus.textContent = "";
      const v = secImportEl.value.trim();
      if (!v) return;

      try {
        const ok = await verifySecurityCode(v);
        questionSecOKImport = ok;
        setCodeStatus(secImportStatus, ok);
        if (ok && (window._importedQuestions || []).length > 0) saveImportBtn.disabled = false;
      } catch (e) {
        console.error(e);
        secImportStatus.textContent = "‚ö†Ô∏è Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c security code";
        secImportStatus.className = "text-warning";
      }
    });
  }

  if (secManualEl) {
    secManualEl.addEventListener("input", async () => {
      questionSecOKManual = false;
      secManualStatus.textContent = "";
      const v = secManualEl.value.trim();
      if (!v) return;

      try {
        const ok = await verifySecurityCode(v);
        questionSecOKManual = ok;
        setCodeStatus(secManualStatus, ok);
      } catch (e) {
        console.error(e);
        secManualStatus.textContent = "‚ö†Ô∏è Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c security code";
        secManualStatus.className = "text-warning";
      }
    });
  }

  if (secEditEl) {
    secEditEl.addEventListener("input", async () => {
      questionSecOKEdit = false;
      secEditStatus.textContent = "";
      const v = secEditEl.value.trim();
      if (!v) return;

      try {
        const ok = await verifySecurityCode(v);
        questionSecOKEdit = ok;
        setCodeStatus(secEditStatus, ok);
      } catch (e) {
        console.error(e);
        secEditStatus.textContent = "‚ö†Ô∏è Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c security code";
        secEditStatus.className = "text-warning";
      }
    });
  }

  // ========= NEW: subjects cache & custom dropdown helpers =========
  let allSubjects = []; // {id, name}

  async function loadAllSubjects() {
    try {
      const snap = await getDocs(collection(db, "mon_hoc"));
      const arr = [];
      snap.forEach(s => arr.push({ id: s.id, name: (s.data().ten_mon || "").toString() }));
      arr.sort((a, b) => a.name.localeCompare(b.name, 'vi', { sensitivity: 'base', numeric: true }));
      allSubjects = arr;
      return arr;
    } catch (e) {
      console.error("L·ªói loadAllSubjects:", e);
      allSubjects = [];
      return [];
    }
  }

  function getSubjectNameById(id) {
    const s = allSubjects.find(x => x.id === id);
    return s ? s.name : "Kh√¥ng r√µ";
  }

  // setupCustomDropdown: buttonId, listId, hiddenId, subjects, defaultText, onSelectCallback
  function setupCustomDropdown(buttonId, listId, hiddenId, subjects, defaultText = "Ch·ªçn m√¥n h·ªçc", onSelect = null) {
    const btn = document.getElementById(buttonId);
    const list = document.getElementById(listId);
    const hidden = document.getElementById(hiddenId);
    if (!btn || !list || !hidden) return;

    // Clear
    list.innerHTML = "";

    // Search box
    const searchLi = document.createElement('li');
    searchLi.className = 'p-2 sticky-top bg-white border-bottom';
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control form-control-sm';
    searchInput.placeholder = 'Nh·∫≠p t√™n m√¥n ƒë·ªÉ t√¨m...';
    searchLi.appendChild(searchInput);
    list.appendChild(searchLi);

    // No result
    const noRes = document.createElement('li');
    noRes.className = 'p-2 text-muted text-center';
    noRes.textContent = 'Kh√¥ng t√¨m th·∫•y m√¥n n√†o';
    noRes.style.display = 'none';
    list.appendChild(noRes);

    // Items
    subjects.forEach(s => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.className = 'dropdown-item';
      a.href = '#';
      a.textContent = s.name;
      a.dataset.id = s.id;
      a.addEventListener('click', (ev) => {
        ev.preventDefault();
        btn.textContent = s.name;
        hidden.value = s.id;
        try {
          const inst = bootstrap.Dropdown.getInstance(btn) || new bootstrap.Dropdown(btn);
          inst.hide();
        } catch (e) {}
        hidden.dispatchEvent(new Event('change'));
        if (onSelect) onSelect(s.id);
      });
      li.appendChild(a);
      list.appendChild(li);
    });

    // search filtering
    searchInput.addEventListener('input', () => {
      const v = searchInput.value.trim().toLowerCase();
      let visible = 0;
      list.querySelectorAll('.dropdown-item').forEach(item => {
        const txt = item.textContent.toLowerCase();
        const li = item.parentElement;
        if (txt.includes(v)) { li.style.display = ''; visible++; } else { li.style.display = 'none'; }
      });
      noRes.style.display = visible === 0 ? 'block' : 'none';
    });

    const parent = btn.closest('.dropdown');
    if (parent) parent.addEventListener('shown.bs.dropdown', () => setTimeout(()=>searchInput.focus(), 20));

    // set default text if no selected
    if (!hidden.value) btn.textContent = defaultText;
    else btn.textContent = getSubjectNameById(hidden.value);
  }

  // repopulate all dropdown UIs when subjects change
  async function populateAllSubjectDropdowns() {
    const subjects = allSubjects;
    setupCustomDropdown('listSyllabusFilter' ? 'btnSyllabusFilter' : '', 'listSyllabusFilter', 'valSyllabusFilter', subjects, 'T·∫•t c·∫£ m√¥n h·ªçc', () => renderSyllabusList());
    setupCustomDropdown('btnEditSyllabusSubject', 'listEditSyllabusSubject', 'valEditSyllabusSubject', subjects, 'Ch·ªçn m√¥n h·ªçc');
    setupCustomDropdown('btnImportSubject', 'listImportSubject', 'valImportSubject', subjects, '-- Ch·ªçn m√¥n h·ªçc ƒë·ªÉ l∆∞u --', async (id) => {
      importHtmlInput.disabled = false;
      importHtmlInput.value = '';
      importHtmlResult.innerHTML = '';
      importHtmlStats.style.display = "none";
      saveImportBtn.style.display = "none";
      window.currentSubjectQuestions = await loadQuestionsForSubject(id);
    });
    setupCustomDropdown('btnManualSubject', 'listManualSubject', 'valManualSubject', subjects, 'Ch·ªçn m√¥n h·ªçc');
    setupCustomDropdown('btnQuestionFilter', 'listQuestionFilter', 'valQuestionFilter', subjects, 'T·∫•t c·∫£ m√¥n h·ªçc', () => renderQuestionList());
    setupCustomDropdown('btnEditSubject', 'listEditSubject', 'valEditSubject', subjects, 'Ch·ªçn m√¥n h·ªçc');
    // For syllabus filter: if valSyllabusFilter empty, show T·∫•t c·∫£ m√¥n h·ªçc
    if (!valSyllabusFilter.value) btnSyllabusFilter.textContent = 'T·∫•t c·∫£ m√¥n h·ªçc';
    if (!valQuestionFilter.value) btnQuestionFilter.textContent = 'T·∫•t c·∫£ m√¥n h·ªçc';
  }

  // call when subjects changed
  async function refreshSubjectsCacheAndUIs() {
    await loadAllSubjects();
    populateAllSubjectDropdowns();
    // also re-render subject list
    await renderSubjectList();
  }

  // ========= HELPERS =========
  async function renderSubjectList() {
    subjectList.innerHTML = '';
    // use allSubjects to render
    if (!allSubjects || allSubjects.length === 0) {
      subjectList.innerHTML = '<div>Ch∆∞a c√≥ m√¥n h·ªçc n√†o.</div>';
      return;
    }
    allSubjects.forEach(s => {
      const div = document.createElement("div");
      div.className = "d-flex justify-content-between align-items-center border p-2 mb-2 subject-list-item";
      div.innerHTML = `
        <span>${s.name}</span>
        <div>
          <button class="btn btn-sm btn-warning me-2">S·ª≠a</button>
          <button class="btn btn-sm btn-danger">X√≥a</button>
        </div>
      `;
      div.querySelector(".btn-warning").onclick = async () => {
        const newName = prompt("Nh·∫≠p t√™n m·ªõi:", s.name);
        if (newName) {
          await updateDoc(doc(db, "mon_hoc", s.id), { ten_mon: newName.trim() });
          await refreshSubjectsCacheAndUIs();
        }
      };
      div.querySelector(".btn-danger").onclick = async () => {
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√¥n h·ªçc "${s.name}"? H√†nh ƒë·ªông n√†y s·∫Ω x√≥a T·∫§T C·∫¢ c√¢u h·ªèi thu·ªôc m√¥n n√†y.`)) {
          await deleteSubjectAndQuestions(s.id);
          await refreshSubjectsCacheAndUIs();
        }
      };
      subjectList.appendChild(div);
    });
  }

  async function deleteSubjectAndQuestions(subjectId) {
    const batch = writeBatch(db);
    const questionsQuery = query(collection(db, "cau_hoi"), where("mon_hoc_id", "==", subjectId));
    const querySnapshot = await getDocs(questionsQuery);
    querySnapshot.forEach((d) => batch.delete(doc(db, "cau_hoi", d.id)));
    batch.delete(doc(db, "mon_hoc", subjectId));
    await batch.commit();
    alert(`ƒê√£ x√≥a th√†nh c√¥ng m√¥n h·ªçc v√† ${querySnapshot.size} c√¢u h·ªèi li√™n quan.`);
  }

  subjectForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (subjectName.value.trim()) {
      await addDoc(collection(db, "mon_hoc"), { ten_mon: subjectName.value.trim() });
      subjectForm.reset();
      await refreshSubjectsCacheAndUIs();
    }
  });

  // ===== SYLLABUS CRUD (uses valSyllabusFilter for filter) =====
  async function refreshSyllabusList() {
    const docs = await getDocs(collection(db, "syllabus"));
    allSyllabusRaw = [];
    docs.forEach(docSnap => {
      const data = docSnap.data();
      data.id = docSnap.id;
      allSyllabusRaw.push(data);
    });
    renderSyllabusList();
  }

  function renderSyllabusList() {
    const filter = valSyllabusFilter.value || "";
    const search = syllabusSearchInput.value.trim().toLowerCase();
    let list = allSyllabusRaw.slice();

    if (filter) list = list.filter(item => item.mon_hoc_id === filter);
    if (search) list = list.filter(item =>
      (item.file_name || "").toLowerCase().includes(search) ||
      (item.owner || "").toLowerCase().includes(search)
    );

    let html = "";
    list.forEach(item => {
      const subjectName = getSubjectNameById(item.mon_hoc_id) || "Kh√¥ng r√µ";
      html += `
        <div class="syllabus-list-item">
          <div><span class="fw-medium">M√¥n h·ªçc:</span> ${subjectName}</div>
          <div><span class="fw-medium">T√™n file:</span> <a href="${item.file_url || "#"}" target="_blank">${item.file_name || ""}</a></div>
          <div><span class="fw-medium">Ch·ªß s·ªü h·ªØu:</span> ${item.owner || ""}</div>
          <div><span class="fw-medium">Ng√†y upload:</span> ${item.uploaded_at ? new Date(item.uploaded_at).toLocaleString() : ""}</div>
          <div class="mt-2">
            <button class="btn btn-sm btn-warning edit-syllabus-btn" data-id="${item.id}">S·ª≠a</button>
            <button class="btn btn-sm btn-danger delete-syllabus-btn" data-id="${item.id}">X√≥a</button>
          </div>
        </div>
      `;
    });

    syllabusListView.innerHTML = html || `<div>Kh√¥ng c√≥ ƒë·ªÅ c∆∞∆°ng n√†o ph√π h·ª£p.</div>`;

    syllabusListView.querySelectorAll(".edit-syllabus-btn").forEach(btn => {
      btn.onclick = () => showEditSyllabusModal(btn.getAttribute("data-id"));
    });
    syllabusListView.querySelectorAll(".delete-syllabus-btn").forEach(btn => {
      btn.onclick = async () => {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë·ªÅ c∆∞∆°ng n√†y?")) {
          await deleteDoc(doc(db, "syllabus", btn.getAttribute("data-id")));
          await refreshSyllabusList();
        }
      }
    });
  }

  syllabusSearchInput.addEventListener("input", renderSyllabusList);
  valSyllabusFilter.addEventListener("change", renderSyllabusList);

  function showEditSyllabusModal(id) {
    const item = allSyllabusRaw.find(x => x.id === id);
    if (!item) return;

    currentEditSyllabusId = id;
    // ensure subjects populated
    loadAllSubjects().then(() => {
      populateAllSubjectDropdowns();
      valEditSyllabusSubject.value = item.mon_hoc_id || "";
      btnEditSyllabusSubject.textContent = getSubjectNameById(item.mon_hoc_id) || 'Ch·ªçn m√¥n h·ªçc';
    });

    editSyllabusOwner.value = item.owner || "";
    editSyllabusFileLink.value = item.file_url || "";
    document.getElementById("currentFileName").innerHTML =
      `File hi·ªán t·∫°i: <a href="${item.file_url}" target="_blank">${item.file_name || ""}</a>`;

    editSyllabusModal.style.display = "flex";
  }

  closeEditSyllabusModal.onclick = () => editSyllabusModal.style.display = "none";

  editSyllabusForm.onsubmit = async (e) => {
    e.preventDefault();
    const subjectId = valEditSyllabusSubject.value;
    const owner = editSyllabusOwner.value.trim();
    const fileUrl = editSyllabusFileLink.value.trim();
    const current = allSyllabusRaw.find(x => x.id === currentEditSyllabusId);

    await updateDoc(doc(db, "syllabus", currentEditSyllabusId), {
      mon_hoc_id: subjectId,
      owner: owner,
      file_url: fileUrl || current?.file_url || null,
      file_name: current?.file_name || null,
      uploaded_at: (new Date()).toISOString()
    });

    editSyllabusModal.style.display = "none";
    editSyllabusForm.reset();
    await refreshSyllabusList();
  };

  // ============================
  //   IMPORT HTML MOODLE (uses valImportSubject)
  // ============================
  let imagesFoundCount = 0;

  function normalizeCompareString(str) {
    return (str || "")
      .replace(/\\\(|\\\)|\[H√åNH ·∫¢NH\]/g, "")
      .replace(/<.*?>/g, "")
      .replace(/[\s\r\n]+/g, " ")
      .trim()
      .toLowerCase();
  }

  function getNormalizedAnswers(lua_chon) {
    return ["a","b","c","d"].map(k => normalizeCompareString(lua_chon?.[k])).filter(x => x);
  }

  function extractTextAndLaTeX(node) {
    let result = "";
    if (!node) return result;
    node.childNodes.forEach(child => {
      if (child.nodeType === Node.TEXT_NODE) {
        result += child.textContent;
      } else if (child.nodeType === Node.ELEMENT_NODE) {
        if (child.tagName === "SCRIPT" && child.type && child.type.startsWith("math/tex")) {
          result += `\\(${child.textContent.trim()}\\)`;
        } else if (child.tagName === "SPAN" && (child.classList.contains("MathJax_Preview") || child.classList.contains("MathJax"))) {
          // skip
        } else if (child.tagName === "IMG" && child.src) {
          imagesFoundCount++;
          result += ` [H√åNH ·∫¢NH] `;
        } else {
          result += extractTextAndLaTeX(child);
        }
      }
    });
    return result.replace(/\s+/g, " ").trim();
  }

  function isDuplicateInSet(question, existSet) {
    const content = normalizeCompareString(question.noi_dung);
    const answers = getNormalizedAnswers(question.lua_chon).sort();
    const correctContent = normalizeCompareString(question.lua_chon?.[question.dap_an_dung]);

    for (const q of existSet) {
      const qContent = normalizeCompareString(q.noi_dung);
      const qAnswers = getNormalizedAnswers(q.lua_chon).sort();
      const qCorrectContent = normalizeCompareString(q.lua_chon?.[q.dap_an_dung]);

      if (content !== qContent) continue;
      if (answers.length !== qAnswers.length) continue;
      if (!answers.every((val, index) => val === qAnswers[index])) continue;
      if (correctContent === qCorrectContent) return true;
    }
    return false;
  }

  async function loadQuestionsForSubject(mon_hoc_id) {
    const qs = [];
    if (!mon_hoc_id) return qs;
    const snapshot = await getDocs(query(collection(db, "cau_hoi"), where("mon_hoc_id", "==", mon_hoc_id)));
    snapshot.forEach(docSnap => qs.push(docSnap.data()));
    return qs;
  }

  valImportSubject.addEventListener("change", () => {
    importHtmlInput.value = "";
    importHtmlResult.innerHTML = "";
    importHtmlStats.style.display = "none";
    saveImportBtn.style.display = "none";
    saveImportBtn.disabled = true;
    importHtmlInput.disabled = !valImportSubject.value;
  });

  importHtmlInput.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const monHocId = valImportSubject.value;
    if (!monHocId) return alert("Vui l√≤ng ch·ªçn m√¥n h·ªçc!");

    const questionSet = await loadQuestionsForSubject(monHocId);

    const reader = new FileReader();
    reader.onload = async (ev) => {
      try {
        imagesFoundCount = 0;
        const text = ev.target.result;
        const docx = new DOMParser().parseFromString(text, "text/html");

        let rawQuestions = [];
        docx.querySelectorAll(".que").forEach(qEl => {
          let qtextNode = qEl.querySelector(".qtext");
          let questionText = qtextNode ? extractTextAndLaTeX(qtextNode) : "";

          const answerNodes = Array.from(qEl.querySelectorAll(".answer > div"));
          const answers = answerNodes.map(ansNode => extractTextAndLaTeX(ansNode.querySelector(".flex-fill, div.ml-1, .specificfeedback") || ansNode));

          let correctIdx = -1;
          const rightAnswerText = qEl.querySelector(".rightanswer")?.innerText || "";
          const match = rightAnswerText.match(/(?:The correct answer is:|C√¢u tr·∫£ l·ªùi ƒë√∫ng l√†:)\s*(.+)$/);

          if (match) {
            const correctValue = match[1].trim();
            correctIdx = answers.findIndex(a => normalizeCompareString(a) === normalizeCompareString(correctValue));
          }
          if (correctIdx === -1) {
            correctIdx = answerNodes.findIndex(node => node.classList.contains("correct"));
          }

          const correctKey = correctIdx !== -1 ? ["a","b","c","d"][correctIdx] : "";
          if (questionText && answers.length >= 2 && correctKey) {
            rawQuestions.push({
              questionText,
              answers,
              correctIdx,
              correctKey,
              lua_chon: { a: answers[0]||"", b: answers[1]||"", c: answers[2]||"", d: answers[3]||"" }
            });
          }
        });

        const rawList = rawQuestions.map(q => ({
          ...q,
          duplicate: isDuplicateInSet(
            { noi_dung: q.questionText, dap_an_dung: q.correctKey, lua_chon: q.lua_chon },
            questionSet
          )
        }));

        const total = rawList.length;
        const images = imagesFoundCount;
        const duplicate = rawList.filter(q => q.duplicate).length;

        importHtmlStats.style.display = "block";
        importHtmlStats.innerHTML = `<b>T·ªïng quan:</b><br>
          - Tr√≠ch xu·∫•t: <b>${total}</b> c√¢u h·ªèi.<br>
          - Ph√°t hi·ªán: <b>${images}</b> h√¨nh ·∫£nh (c·∫ßn th√™m th·ªß c√¥ng).<br>
          - Tr√πng l·∫∑p: <b>${duplicate}</b> c√¢u h·ªèi (s·∫Ω b·ªè qua).`;

        let html = `<div class="fw-bold mb-2">K·∫øt qu·∫£ tr√≠ch xu·∫•t (${rawList.length} c√¢u):</div>`;
        rawList.forEach((q, idx) => {
          html += `<div class="import-question${q.duplicate ? " import-duplicate" : ""}">
            <div><b>C√¢u ${idx+1}:</b> <span class="mathjax-content">${q.questionText}</span></div>`;
          q.answers.forEach((ans, i) => {
            html += `<div class="import-answer${i===q.correctIdx ? " import-answer-correct" : ""}">
              ${String.fromCharCode(97+i)}. <span class="mathjax-content">${ans}</span> ${i===q.correctIdx ? "<span> (ƒê√°p √°n ƒë√∫ng)</span>" : ""}
            </div>`;
          });
          if (q.duplicate) html += `<div class="import-duplicate" style="font-style: italic;">[Tr√πng] C√¢u h·ªèi n√†y s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u!</div>`;
          html += `</div>`;
        });

        importHtmlResult.innerHTML = html;

        window.MathJax && window.MathJax.typesetPromise && MathJax.typesetPromise(Array.from(importHtmlResult.querySelectorAll(".mathjax-content")));

        window._importedQuestions = rawList;
        window._importedMonHocId = monHocId;

        saveImportBtn.style.display = rawList.length > 0 ? "inline-block" : "none";
        saveImportBtn.disabled = !(questionSecOKImport && (secImportEl?.value.trim()));
      } catch (err) {
        console.error("L·ªói parse HTML:", err);
        alert("L·ªói parse HTML. Xem Console (F12).");
      }
    };
    reader.readAsText(file);
  });

  saveImportBtn.onclick = async () => {
    const monHocId = window._importedMonHocId;
    const list = window._importedQuestions || [];

    if (!monHocId) return alert("Vui l√≤ng ch·ªçn m√¥n h·ªçc ƒë·ªÉ l∆∞u!");
    const questionsToSave = list.filter(q => !q.duplicate);
    if (questionsToSave.length === 0) return alert("Kh√¥ng c√≥ c√¢u h·ªèi m·ªõi n√†o ƒë·ªÉ l∆∞u!");

    const securityCode = secImportEl?.value.trim() || "";
    if (!securityCode) return alert("Vui l√≤ng nh·∫≠p Security code!");
    if (!questionSecOKImport) return alert("Security code ch∆∞a ƒë√∫ng, kh√¥ng th·ªÉ l∆∞u!");

    saveImportBtn.disabled = true;
    let n = 0, err = 0, dup = list.length - questionsToSave.length;

    for (let q of questionsToSave) {
      try {
        await addDoc(collection(db, "cau_hoi"), {
          mon_hoc_id: monHocId,
          noi_dung: q.questionText,
          noi_dung_img: "",
          lua_chon: q.lua_chon,
          dap_an_dung: q.correctKey,
          security_code: securityCode
        });
        n++;
      } catch (e) {
        console.error("L·ªói l∆∞u c√¢u h·ªèi:", e);
        err++;
      }
    }

    alert(`ƒê√£ l∆∞u ${n} c√¢u h·ªèi${dup>0 ? `, b·ªè qua ${dup} c√¢u tr√πng` : ""}${err>0 ? `, l·ªói ${err} c√¢u` : ""}.`);
    saveImportBtn.disabled = false;

    importHtmlInput.value = "";
    importHtmlResult.innerHTML = "";
    importHtmlStats.style.display = "none";
    saveImportBtn.style.display = "none";
    saveImportBtn.disabled = true;
    window._importedQuestions = [];
  };

  // ============================
  //   QUESTIONS CRUD
  // ============================
  // loadAllSubjects + populate UIs already provided above

  async function loadSubjectsDropdownsInitial() {
    await refreshSubjectsCacheAndUIs();
  }

  async function loadQuestionsForListAndRender(filter = null) {
    const arr = [];
    const snap = await getDocs(collection(db, "cau_hoi"));
    snap.forEach(docSnap => {
      const data = docSnap.data();
      data.id = docSnap.id;
      arr.push(data);
    });
    window.allQuestionsRaw = arr;
    renderQuestionList();
  }

  // Manual add question (requires security_code) - use valManualSubject
  questionForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const monHocId = valManualSubject.value;
    const qText = questionText.value.trim();
    const a = answerA.value.trim();
    const b = answerB.value.trim();
    const c = answerC.value.trim();
    const d = answerD.value.trim();
    const correct = correctAnswerDropdown.value;

    if (!(monHocId && qText && a && b && c && d && correct)) return;

    const securityCode = secManualEl?.value.trim() || "";
    if (!securityCode) return alert("Vui l√≤ng nh·∫≠p Security code!");
    if (!questionSecOKManual) return alert("Security code ch∆∞a ƒë√∫ng!");

    try {
      const choices = { a, b, c, d };

      const existingQuestions = await loadQuestionsForSubject(monHocId);
      if (isDuplicateInSet({ noi_dung: qText, dap_an_dung: correct, lua_chon: choices }, existingQuestions)) {
        return alert("C√¢u h·ªèi n√†y ƒë√£ t·ªìn t·∫°i trong m√¥n h·ªçc v·ªõi ƒë√°p √°n ƒë√∫ng gi·ªëng nhau!");
      }

      await addDoc(collection(db, "cau_hoi"), {
        mon_hoc_id: monHocId,
        noi_dung: qText,
        noi_dung_img: "",
        lua_chon: choices,
        dap_an_dung: correct,
        security_code: securityCode
      });

      questionForm.reset();
      secManualStatus.textContent = "";
      secManualStatus.className = "text-muted";
      questionSecOKManual = false;
      alert("‚úÖ ƒê√£ th√™m c√¢u h·ªèi!");
    } catch (err) {
      console.error("L·ªói th√™m c√¢u h·ªèi:", err);
      alert("Kh√¥ng th√™m ƒë∆∞·ª£c c√¢u h·ªèi. Xem Console (F12).");
    }
  });

  // ===== QUESTION LIST =====
  let allQuestionsRaw = [];
  let currentEditQid = null;

  function renderQuestionList() {
    const search = questionSearchInput.value.trim().toLowerCase();
    const filter = valQuestionFilter.value || "";

    let arr = allQuestionsRaw.slice();
    if (filter) arr = arr.filter(q => q.mon_hoc_id === filter);
    if (search) arr = arr.filter(q => (q.noi_dung || "").toLowerCase().includes(search));

    let html = "";
    arr.forEach(q => {
      const subjectName = getSubjectNameById(q.mon_hoc_id) || "Kh√¥ng r√µ";

      html += `
        <div class="question-list-item">
          <div><span class="fw-medium">M√¥n h·ªçc:</span> ${subjectName}</div>
          <div><span class="fw-medium">C√¢u h·ªèi:</span> <span class="mathjax-content">${q.noi_dung || ""}</span></div>

          <div class="question-list-answers">
            ${["a","b","c","d"].map(t => {
              const correct = q.dap_an_dung === t;
              const ans = (q.lua_chon && q.lua_chon[t]) ? q.lua_chon[t] : "";
              return `
                <div class="answer-item${correct ? " correct" : ""}">
                  ${t}. <span class="mathjax-content">${ans}</span>
                </div>
              `;
            }).join("")}
          </div>

          <div class="mt-2 d-flex align-items-center">
            <input type="checkbox" class="form-check-input question-checkbox me-3" data-id="${q.id}">
            <button class="btn btn-sm btn-warning edit-btn" data-id="${q.id}">S·ª≠a</button>
            <button class="btn btn-sm btn-danger delete-btn ms-2" data-id="${q.id}">X√≥a</button>
          </div>
        </div>
      `;
    });

    questionListView.innerHTML = html || `<div>Kh√¥ng c√≥ c√¢u h·ªèi n√†o ph√π h·ª£p.</div>`;
    window.MathJax && window.MathJax.typesetPromise && MathJax.typesetPromise(Array.from(questionListView.querySelectorAll(".mathjax-content")));

    questionListView.querySelectorAll(".edit-btn").forEach(btn => {
      btn.onclick = () => showEditModal(btn.getAttribute("data-id"));
    });

    questionListView.querySelectorAll(".delete-btn").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute("data-id");
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¢u h·ªèi n√†y?")) return;

        try {
          await deleteDoc(doc(db, "cau_hoi", id));
          await loadQuestionsForListAndRender(valQuestionFilter.value || null);
        } catch (e) {
          console.error("L·ªói x√≥a:", e);
          alert("Kh√¥ng x√≥a ƒë∆∞·ª£c. Xem Console (F12). N·∫øu Rules ch·∫∑n delete, c·∫ßn s·ª≠a Rules.");
        }
      }
    });

    updateBulkDeleteButtonState();
  }

  async function refreshQuestionList(selectedFilter = null) {
    await loadSubjectsDropdownsInitial();
    if (selectedFilter) valQuestionFilter.value = selectedFilter;
    const arr = [];
    const snap = await getDocs(collection(db, "cau_hoi"));
    snap.forEach(docSnap => {
      const data = docSnap.data();
      data.id = docSnap.id;
      arr.push(data);
    });

    allQuestionsRaw = arr;
    renderQuestionList();
  }

  questionSearchInput.addEventListener("input", renderQuestionList);
  valQuestionFilter.addEventListener("change", renderQuestionList);

  // ===== EDIT QUESTION =====
  async function showEditModal(qid) {
    const q = allQuestionsRaw.find(x => x.id === qid);
    if (!q) return;

    currentEditQid = qid;
    questionSecOKEdit = false;
    secEditStatus.textContent = "";
    secEditStatus.className = "text-muted";
    secEditEl.value = "";

    await loadAllSubjects();
    populateAllSubjectDropdowns();
    valEditSubject.value = q.mon_hoc_id || "";
    btnEditSubject.textContent = getSubjectNameById(q.mon_hoc_id) || 'Ch·ªçn m√¥n h·ªçc';

    editQuestionText.value = q.noi_dung || "";
    editAnswerA.value = q.lua_chon?.a || "";
    editAnswerB.value = q.lua_chon?.b || "";
    editAnswerC.value = q.lua_chon?.c || "";
    editAnswerD.value = q.lua_chon?.d || "";
    editCorrectAnswerDropdown.value = q.dap_an_dung || "";

    editQuestionModal.style.display = "flex";
  }

  closeEditModal.onclick = () => editQuestionModal.style.display = "none";

  editForm.onsubmit = async (e) => {
    e.preventDefault();

    const monHocId = valEditSubject.value;
    const qText = editQuestionText.value.trim();
    const a = editAnswerA.value.trim();
    const b = editAnswerB.value.trim();
    const c = editAnswerC.value.trim();
    const d = editAnswerD.value.trim();
    const correct = editCorrectAnswerDropdown.value;

    if (!(monHocId && qText && a && b && c && d && correct)) return;

    const securityCode = secEditEl?.value.trim() || "";
    if (!securityCode) return alert("Vui l√≤ng nh·∫≠p Security code ƒë·ªÉ s·ª≠a!");
    if (!questionSecOKEdit) return alert("Security code ch∆∞a ƒë√∫ng!");

    try {
      const choices = { a, b, c, d };

      await updateDoc(doc(db, "cau_hoi", currentEditQid), {
        mon_hoc_id: monHocId,
        noi_dung: qText,
        noi_dung_img: "",
        lua_chon: choices,
        dap_an_dung: correct,
        security_code: securityCode,
        updated_at: (new Date()).toISOString()
      });

      await refreshQuestionList(valQuestionFilter.value || null);
      editQuestionModal.style.display = "none";
      alert("‚úÖ ƒê√£ l∆∞u s·ª≠a ƒë·ªïi!");
    } catch (err) {
      console.error("L·ªói s·ª≠a c√¢u h·ªèi:", err);
      alert("Kh√¥ng s·ª≠a ƒë∆∞·ª£c. Xem Console (F12).");
    }
  };

  // ===== BULK DELETE =====
  function updateBulkDeleteButtonState() {
    const selectedCheckboxes = questionListView.querySelectorAll(".question-checkbox:checked");
    deleteSelectedBtn.style.display = selectedCheckboxes.length > 0 ? "inline-block" : "none";
  }

  questionListView.addEventListener("change", (e) => {
    if (e.target.classList.contains("question-checkbox")) updateBulkDeleteButtonState();
  });

  selectAllCheckbox.addEventListener("change", () => {
    const allCheckboxes = questionListView.querySelectorAll(".question-checkbox");
    allCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
    updateBulkDeleteButtonState();
  });

  deleteSelectedBtn.addEventListener("click", async () => {
    const selectedCheckboxes = questionListView.querySelectorAll(".question-checkbox:checked");
    const idsToDelete = Array.from(selectedCheckboxes).map(cb => cb.getAttribute("data-id"));
    if (idsToDelete.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt c√¢u h·ªèi.");

    if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${idsToDelete.length} c√¢u h·ªèi ƒë√£ ch·ªçn kh√¥ng?`)) return;

    try {
      const batch = writeBatch(db);
      idsToDelete.forEach(id => batch.delete(doc(db, "cau_hoi", id)));
      await batch.commit();
      alert(`ƒê√£ x√≥a th√†nh c√¥ng ${idsToDelete.length} c√¢u h·ªèi.`);
      await refreshQuestionList(valQuestionFilter.value || null);
    } catch (error) {
      console.error("L·ªói khi x√≥a h√†ng lo·∫°t: ", error);
      alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a h√†ng lo·∫°t. Xem Console (F12). N·∫øu Rules ch·∫∑n delete, c·∫ßn s·ª≠a Rules.");
    }
  });

  // ===== UI NAVIGATION =====
  importHtmlBtn.onclick = () => {
    questionModeChoice.style.display = "none";
    importHtmlSection.style.display = "block";
    manualSection.style.display = "none";
    questionListSection.style.display = "none";

    importHtmlResult.innerHTML = "";
    importHtmlStats.style.display = "none";
    importHtmlInput.value = "";
    saveImportBtn.style.display = "none";
    saveImportBtn.disabled = true;

    loadSubjectsDropdownsInitial();
    importHtmlInput.disabled = true;

    backToChoice1.classList.remove("d-none");
    backToChoice2.classList.add("d-none");
    backToChoice3.classList.add("d-none");
  };

  manualBtn.onclick = () => {
    questionModeChoice.style.display = "none";
    importHtmlSection.style.display = "none";
    manualSection.style.display = "block";
    questionListSection.style.display = "none";

    backToChoice2.classList.remove("d-none");
    backToChoice1.classList.add("d-none");
    backToChoice3.classList.add("d-none");
  };

  backToChoice1.onclick = backToChoice2.onclick = backToChoice3.onclick = () => showQuestionChoice();

  function showQuestionChoice() {
    questionModeChoice.style.display = "block";
    importHtmlSection.style.display = "none";
    manualSection.style.display = "none";
    questionListSection.style.display = "none";
    backToChoice1.classList.add("d-none");
    backToChoice2.classList.add("d-none");
    backToChoice3.classList.add("d-none");
  }

  viewQuestionListBtn.onclick = async () => {
    questionModeChoice.style.display = "none";
    importHtmlSection.style.display = "none";
    manualSection.style.display = "none";
    questionListSection.style.display = "block";

    document.getElementById("bulk-action-bar").style.display = "flex";
    await refreshQuestionList();

    backToChoice3.classList.remove("d-none");
    backToChoice1.classList.add("d-none");
    backToChoice2.classList.add("d-none");
  };

  // ===== INIT =====
  async function showChoice() {
    document.querySelectorAll(".mode-section").forEach(e => e.style.display = "none");

    if (modeSelect.value === "subject") {
      subjectSection.style.display = "block";
      await refreshSubjectsCacheAndUIs();
    } else if (modeSelect.value === "syllabus") {
      syllabusSection.style.display = "block";
      await refreshSubjectsCacheAndUIs();
      await refreshSyllabusList();
    } else if (modeSelect.value === "question") {
      questionSection.style.display = "block";
      showQuestionChoice();
      await refreshSubjectsCacheAndUIs();
      await loadQuestionsForListAndRender();
    }

    backToChoice1.classList.add("d-none");
    backToChoice2.classList.add("d-none");
    backToChoice3.classList.add("d-none");
  }

  modeSelect.addEventListener("change", showChoice);
  showChoice();

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // T·∫£i menu
  fetch('/menu.html')
    .then(r => r.text())
    .then(html => document.getElementById('navbar-placeholder').innerHTML = html);
</script>

</body>
</html>
